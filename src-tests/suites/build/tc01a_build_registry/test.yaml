# Test Case: Build mcp-mesh-registry Go Binary
# Builds the registry binary from Go source code
#
# IMPORTANT: This test runs on the HOST (standalone mode)
# Build commands execute inside src-build:latest via docker run

name: "Build mcp-mesh-registry"
description: "Build mcp-mesh-registry Go binary from source using docker run"
tags:
  - build
  - go
  - registry
timeout: 300

test:
  # Ensure output directories exist
  - name: "Create output directories"
    handler: shell
    command: |
      mkdir -p "${suite_path}/${config.output.bin}"
      echo "Output directory ready: ${suite_path}/${config.output.bin}"
    capture: dir_check

  # Check source availability on host
  - name: "Check source code on host"
    handler: shell
    command: |
      # Resolve source path relative to suite directory
      SOURCE_PATH="${suite_path}/${config.source.path}"
      if [ -d "$SOURCE_PATH/cmd/mcp-mesh-registry" ]; then
        echo "Found mcp-mesh-registry source at $SOURCE_PATH/cmd/mcp-mesh-registry"
        ls -la "$SOURCE_PATH/cmd/mcp-mesh-registry/"
      else
        echo "ERROR: Source not found at $SOURCE_PATH/cmd/mcp-mesh-registry"
        exit 1
      fi
    capture: source_check

  # Build mcp-mesh-registry using docker run
  - name: "Build mcp-mesh-registry binary"
    handler: shell
    command: |
      # Get absolute paths for docker volume mounts (relative to suite_path)
      SOURCE_ABS=$(cd "${suite_path}/${config.source.path}" && pwd)
      OUTPUT_ABS=$(cd "${suite_path}/${config.output.base}" && pwd)

      echo "Source: $SOURCE_ABS"
      echo "Output: $OUTPUT_ABS"

      echo "Building mcp-mesh-registry inside container..."
      docker run --rm \
        -v "$SOURCE_ABS:/src/mcp-mesh:ro" \
        -v "$OUTPUT_ABS:/out" \
        ${config.build.image} \
        bash -c "cd /src/mcp-mesh && go build -o /out/bin/mcp-mesh-registry ./cmd/mcp-mesh-registry/"

      echo "Build complete"
    capture: build_output
    timeout: 180

  # Verify binary was created on host
  - name: "Verify mcp-mesh-registry binary"
    handler: shell
    command: |
      ls -la "${suite_path}/${config.output.bin}/mcp-mesh-registry"
      file "${suite_path}/${config.output.bin}/mcp-mesh-registry"
    capture: verify_output

  # Test the binary on host (if compatible)
  - name: "Test mcp-mesh-registry binary"
    handler: shell
    command: |
      # Try to run the binary - may fail if built for different arch
      if "${suite_path}/${config.output.bin}/mcp-mesh-registry" --help 2>/dev/null; then
        echo "mcp-mesh-registry runs on host"
      else
        echo "mcp-mesh-registry built but may be for different architecture (expected in cross-platform builds)"
        echo "Binary exists: $(ls "${suite_path}/${config.output.bin}/mcp-mesh-registry")"
      fi
    capture: test_output

assertions:
  - expr: ${captured.build_output} contains 'Build complete'
    message: "mcp-mesh-registry build should complete successfully"

  - expr: ${captured.verify_output} contains 'mcp-mesh-registry'
    message: "mcp-mesh-registry binary should exist"
