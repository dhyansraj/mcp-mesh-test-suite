# Test Case: Build Rust Core (mcp-mesh-core)
# Builds the Rust core library with Python bindings via maturin
#
# IMPORTANT: This test runs on the HOST (standalone mode)
# Build commands execute inside src-build:latest via docker run

name: "Build Rust Core"
description: "Build mcp-mesh-core Python wheel from Rust source using docker run"
tags:
  - build
  - rust
  - python
timeout: 600

test:
  # Ensure output directories exist
  - name: "Create output directories"
    handler: shell
    command: |
      mkdir -p "${suite_path}/${config.output.wheels}"
      echo "Output directory ready: ${suite_path}/${config.output.wheels}"
    capture: dir_check

  # Check source availability on host
  - name: "Check Rust source code on host"
    handler: shell
    command: |
      SOURCE_PATH="${suite_path}/${config.source.path}"
      if [ -d "$SOURCE_PATH/src/runtime/core" ]; then
        echo "Found Rust core source at $SOURCE_PATH/src/runtime/core"
        ls -la "$SOURCE_PATH/src/runtime/core/"
        cat "$SOURCE_PATH/src/runtime/core/Cargo.toml"
      else
        echo "ERROR: Rust source not found at $SOURCE_PATH/src/runtime/core"
        exit 1
      fi
    capture: source_check

  # Build with maturin using docker run
  - name: "Build mcp-mesh-core wheel"
    handler: shell
    command: |
      # Get absolute paths for docker volume mounts (relative to suite_path)
      SOURCE_ABS=$(cd "${suite_path}/${config.source.path}" && pwd)
      OUTPUT_ABS=$(cd "${suite_path}/${config.output.base}" && pwd)

      echo "Source: $SOURCE_ABS"
      echo "Output: $OUTPUT_ABS"

      echo "Building with maturin inside container..."
      docker run --rm \
        -v "$SOURCE_ABS:/src/mcp-mesh:ro" \
        -v "$OUTPUT_ABS:/out" \
        ${config.build.image} \
        bash -c "cd /src/mcp-mesh/src/runtime/core && maturin build --release --out /out/wheels"

      echo "Maturin build complete"
    capture: build_output
    timeout: 480

  # List built wheels on host
  - name: "List built wheels"
    handler: shell
    command: |
      echo "Built wheels:"
      ls -la "${suite_path}/${config.output.wheels}"/mcp_mesh_core*.whl 2>/dev/null || ls -la "${suite_path}/${config.output.wheels}"/*.whl
    capture: wheel_list

  # Verify wheel can be installed (using docker to ensure compatibility)
  - name: "Verify wheel installation"
    handler: shell
    command: |
      OUTPUT_ABS=$(cd "${suite_path}/${config.output.base}" && pwd)

      echo "Testing wheel installation inside container..."
      docker run --rm \
        -v "$OUTPUT_ABS:/out:ro" \
        ${config.build.image} \
        bash -c "pip install /out/wheels/mcp_mesh_core*.whl && python -c 'import mcp_mesh_core; print(\"mcp_mesh_core imported successfully\")'"
    capture: install_output

assertions:
  - expr: ${captured.build_output} contains 'Maturin build complete'
    message: "Maturin build should complete successfully"

  - expr: ${captured.wheel_list} contains '.whl'
    message: "Wheel file should be created"

  - expr: ${captured.install_output} contains 'imported successfully'
    message: "mcp_mesh_core should be importable"
