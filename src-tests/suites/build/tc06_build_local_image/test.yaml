# Test Case: Build tsuite-mesh:local Image
# Builds the Docker image from locally compiled packages
#
# IMPORTANT: This test runs on the HOST (standalone mode)
# Run after tc01-tc05 have built all artifacts

name: "Build tsuite-mesh:local Image"
description: "Build Docker image with locally compiled MCP Mesh packages"
tags:
  - docker
  - build
  - image
  - local
timeout: 600  # 10 minutes for image build

test:
  # Verify Docker is available
  - name: "Verify Docker is available"
    handler: shell
    command: |
      docker --version
      docker info > /dev/null 2>&1 && echo "Docker daemon is running"
    capture: docker_check

  # Verify all artifacts exist
  - name: "Verify build artifacts exist"
    handler: shell
    command: |
      echo "Checking build artifacts..."

      # Check meshctl binary
      if [ ! -f "${suite_path}/${config.output.bin}/meshctl" ]; then
        echo "ERROR: meshctl binary not found at ${suite_path}/${config.output.bin}/meshctl"
        exit 1
      fi
      echo "  meshctl: OK"

      # Check Python wheels
      WHEEL_COUNT=$(ls "${suite_path}/${config.output.wheels}"/*.whl 2>/dev/null | wc -l)
      if [ "$WHEEL_COUNT" -lt 2 ]; then
        echo "ERROR: Expected at least 2 wheels, found $WHEEL_COUNT"
        ls -la "${suite_path}/${config.output.wheels}/"
        exit 1
      fi
      echo "  wheels: $WHEEL_COUNT found"

      # Check npm packages
      if ! ls "${suite_path}/${config.output.packages}"/*.tgz 1>/dev/null 2>&1; then
        echo "ERROR: No npm tarballs found in ${suite_path}/${config.output.packages}"
        exit 1
      fi
      echo "  packages: OK"

      echo ""
      echo "All artifacts ready for image build"
    capture: artifacts_check

  # Prepare build context
  - name: "Prepare build context"
    handler: shell
    command: |
      # Create a temporary build context with all artifacts
      BUILD_DIR=$(mktemp -d)
      echo "BUILD_DIR=$BUILD_DIR"

      # Get Dockerfile from artifacts_path
      DOCKERFILE_PATH="${artifacts_path}/Dockerfile"

      # Copy Dockerfile
      cp "$DOCKERFILE_PATH" $BUILD_DIR/

      # Copy artifacts
      mkdir -p $BUILD_DIR/bin $BUILD_DIR/wheels $BUILD_DIR/packages
      cp "${suite_path}/${config.output.bin}/meshctl" $BUILD_DIR/bin/
      cp "${suite_path}/${config.output.wheels}"/*.whl $BUILD_DIR/wheels/
      cp "${suite_path}/${config.output.packages}"/*.tgz $BUILD_DIR/packages/

      echo "Build context prepared at $BUILD_DIR"
      ls -la $BUILD_DIR/
      ls -la $BUILD_DIR/wheels/
      ls -la $BUILD_DIR/packages/
    capture: build_context

  # Build the image
  - name: "Build tsuite-mesh:local image"
    handler: shell
    command: |
      BUILD_DIR=$(echo "${captured.build_context}" | grep "BUILD_DIR=" | cut -d= -f2)
      IMAGE_NAME="${config.docker.output_image}"

      echo "Building image: $IMAGE_NAME"
      echo "Build context: $BUILD_DIR"

      docker build \
        -t $IMAGE_NAME \
        -f $BUILD_DIR/Dockerfile \
        $BUILD_DIR

      # Cleanup build context
      rm -rf $BUILD_DIR

      echo "IMAGE_NAME=$IMAGE_NAME"
    capture: build_output
    timeout: 480

  # Verify image was created
  - name: "Verify image was created"
    handler: shell
    command: |
      docker images ${config.docker.output_image} --format "{{.Repository}}:{{.Tag}} - {{.Size}}"
    capture: image_info

  # Test the image - verify meshctl
  - name: "Test meshctl in image"
    handler: shell
    command: |
      docker run --rm ${config.docker.output_image} meshctl --version
    capture: meshctl_version

  # Test the image - verify mesh module
  - name: "Test mesh module in image"
    handler: shell
    command: |
      docker run --rm ${config.docker.output_image} python -c "import mesh; print('mesh OK')"
    capture: mesh_check

  # Test the image - verify /wheels and /packages exist
  - name: "Verify /wheels and /packages in image"
    handler: shell
    command: |
      docker run --rm ${config.docker.output_image} bash -c "ls /wheels/*.whl && ls /packages/*.tgz"
    capture: packages_check

  # Test the image - verify node
  - name: "Test Node.js in image"
    handler: shell
    command: |
      docker run --rm ${config.docker.output_image} node --version
    capture: node_version

  # Print summary
  - name: "Print summary"
    handler: shell
    command: |
      echo ""
      echo "=========================================="
      echo "tsuite-mesh:local built successfully!"
      echo "=========================================="
      echo ""
      echo "Image: ${config.docker.output_image}"
      echo "meshctl: ${captured.meshctl_version}"
      echo "node: ${captured.node_version}"
      echo "mesh: OK"
      echo ""
      echo "To use with integration tests:"
      echo "  1. Update integration/config.yaml:"
      echo "     docker:"
      echo "       base_image: \"${config.docker.output_image}\""
      echo ""
      echo "  2. Run integration tests:"
      echo "     cd integration && tsuite --all --docker"
      echo ""
      echo "The handlers will auto-detect /wheels and /packages"
      echo "and install from local builds."
      echo "=========================================="
    capture: summary

assertions:
  # Docker should be available
  - expr: ${captured.docker_check} contains 'Docker daemon is running'
    message: "Docker daemon should be running"

  # Artifacts should exist
  - expr: ${captured.artifacts_check} contains 'All artifacts ready'
    message: "All build artifacts should exist"

  # Build should succeed
  - expr: ${captured.build_output} contains 'IMAGE_NAME='
    message: "Docker build should succeed"

  # Image should exist
  - expr: ${captured.image_info} contains 'tsuite-mesh:local'
    message: "Image should be created"

  # meshctl should work
  - expr: ${captured.meshctl_version} contains 'meshctl'
    message: "meshctl should be installed and working"

  # mesh module should work
  - expr: ${captured.mesh_check} contains 'mesh OK'
    message: "mesh module should be importable"

  # Packages should exist in image
  - expr: ${captured.packages_check} contains '.whl'
    message: "/wheels should contain wheel files"

  # Node should be installed
  - expr: ${captured.node_version} contains 'v22'
    message: "Node.js 22 should be installed"
