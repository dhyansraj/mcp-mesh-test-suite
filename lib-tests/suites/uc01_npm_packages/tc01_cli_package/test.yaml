# Test Case: @mcpmesh/cli Package
# Verifies the CLI package exists on npm and is installable

name: "@mcpmesh/cli Package Verification"
description: "Test that @mcpmesh/cli package exists, installs, and --version works"
tags:
  - npm
  - cli
  - package
timeout: 120

test:
  # Check package exists on npm registry
  - handler: shell
    command: |
      echo "Checking @mcpmesh/cli@${config.packages.cli_version} on npm..."
      npm view @mcpmesh/cli@${config.packages.cli_version} version
    capture: npm_view_output

  # Create temp directory and install package
  - handler: shell
    command: |
      TMPDIR=$(mktemp -d)
      cd $TMPDIR
      echo "Installing @mcpmesh/cli@${config.packages.cli_version} in $TMPDIR..."
      npm install @mcpmesh/cli@${config.packages.cli_version}
      echo "TMPDIR=$TMPDIR"
    capture: install_output

  # Verify meshctl --version works
  - handler: shell
    command: |
      TMPDIR=$(echo "${captured.install_output}" | grep "TMPDIR=" | cut -d= -f2)
      cd $TMPDIR
      ./node_modules/.bin/meshctl --version
    capture: version_output

  # Clean up
  - handler: shell
    command: |
      TMPDIR=$(echo "${captured.install_output}" | grep "TMPDIR=" | cut -d= -f2)
      rm -rf $TMPDIR
    ignore_errors: true

assertions:
  # Package version should match
  - expr: ${captured.npm_view_output} contains '${config.packages.cli_version}'
    message: "npm view should return correct version"

  # Install should succeed
  - expr: ${captured.install_output} contains '@mcpmesh/cli'
    message: "npm install should succeed"

  # --version should return version number
  - expr: ${captured.version_output} contains '${config.packages.cli_version}'
    message: "meshctl --version should return correct version"
