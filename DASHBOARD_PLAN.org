#+TITLE: tsuite Dashboard Implementation Plan
#+AUTHOR: MCP Mesh Team
#+DATE: 2026-01-19
#+OPTIONS: toc:3 num:t

* Overview

Real-time test dashboard for tsuite with SSE streaming and historical run analysis.

** Design Theme
- Dark navy background (#0a1628)
- Cyan/teal primary (#22d3ee)
- Orange accent (#f97316)
- Pink/magenta secondary (#ec4899)
- Card containers with subtle borders
- Clean, modern typography

** Tech Stack
- Next.js 14 (App Router)
- Tailwind CSS
- shadcn/ui components
- Recharts for visualizations
- SSE for real-time updates

* Architecture

#+BEGIN_SRC
┌─────────────────────────────────────────────────────────────────┐
│                     dashboard/ (Next.js)                         │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌─────────────┐  │
│  │ Dashboard  │  │   Runs    │  │   Tests   │  │  Live View  │  │
│  │  Overview  │  │  History  │  │  Details  │  │   (SSE)     │  │
│  └───────────┘  └───────────┘  └───────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                               │
                          REST + SSE
                               │
┌─────────────────────────────────────────────────────────────────┐
│                     tsuite Backend                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  REST API   │  │  SSE Stream │  │  SQLite DB              │  │
│  │  /api/*     │  │  /events    │  │  (runs, tests, steps)   │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
#+END_SRC

* Directory Structure

#+BEGIN_SRC
mcp-mesh-test-suite/
├── tsuite/              # Existing framework
│   └── tsuite/
│       ├── api.py       # NEW: REST API endpoints
│       └── sse.py       # NEW: SSE event streaming
├── dashboard/           # NEW: Next.js frontend
│   ├── app/
│   │   ├── layout.tsx
│   │   ├── page.tsx           # Dashboard overview
│   │   ├── runs/
│   │   │   ├── page.tsx       # Run history
│   │   │   └── [id]/
│   │   │       └── page.tsx   # Run details
│   │   ├── live/
│   │   │   └── page.tsx       # Live test view
│   │   └── api/
│   │       └── [...proxy]/    # Proxy to tsuite backend
│   ├── components/
│   │   ├── ui/                # shadcn components
│   │   ├── layout/
│   │   │   ├── Sidebar.tsx
│   │   │   ├── Header.tsx
│   │   │   └── Logo.tsx
│   │   ├── dashboard/
│   │   │   ├── StatsCards.tsx
│   │   │   ├── RecentRuns.tsx
│   │   │   ├── PassRateChart.tsx
│   │   │   └── TestTrends.tsx
│   │   ├── runs/
│   │   │   ├── RunList.tsx
│   │   │   ├── RunCard.tsx
│   │   │   └── RunFilters.tsx
│   │   ├── tests/
│   │   │   ├── TestList.tsx
│   │   │   ├── TestCard.tsx
│   │   │   ├── StepTimeline.tsx
│   │   │   └── AssertionBadge.tsx
│   │   └── live/
│   │       ├── LiveFeed.tsx
│   │       ├── RunningTest.tsx
│   │       └── StepProgress.tsx
│   ├── lib/
│   │   ├── api.ts             # API client
│   │   ├── sse.ts             # SSE client hook
│   │   └── utils.ts
│   ├── public/
│   │   └── logo-cyan.svg      # MCP Mesh logo (copy from images/)
│   ├── package.json
│   ├── tailwind.config.ts
│   └── next.config.js
├── integration/         # Existing test suites
└── lib-tests/           # Existing lib tests
#+END_SRC

* Implementation Phases

** Phase 1: Backend API [0/4]
*** TODO Add REST API to tsuite
- [ ] GET /api/runs - List all runs with pagination
- [ ] GET /api/runs/:id - Get run details with tests
- [ ] GET /api/runs/:id/tests - Get tests for a run
- [ ] GET /api/runs/:id/tests/:test_id - Get test details with steps
- [ ] GET /api/stats - Dashboard statistics

*** TODO Add SSE streaming endpoint
- [ ] GET /api/events - SSE stream for live updates
- [ ] Event types: run_started, test_started, step_completed, test_completed, run_completed
- [ ] Include test metadata and step results in events

*** TODO Update tsuite CLI
- [ ] Add --dashboard flag to enable API server
- [ ] Add standalone dashboard command: tsuite dashboard [--port 3001]
- [ ] Emit SSE events during test execution

*** TODO Database schema updates
- [ ] Add step_results table for granular step tracking
- [ ] Add captured_output field for step logs
- [ ] Index optimization for dashboard queries

** Phase 2: Next.js Setup [0/3]
*** TODO Initialize Next.js project
#+BEGIN_SRC bash
cd mcp-mesh-test-suite
npx create-next-app@latest dashboard --typescript --tailwind --eslint --app --src-dir=false
cd dashboard
npx shadcn@latest init
#+END_SRC

*** TODO Configure Tailwind theme
#+BEGIN_SRC javascript
// tailwind.config.ts
const config = {
  theme: {
    extend: {
      colors: {
        background: '#0a1628',
        surface: '#0f2744',
        border: '#1e3a5f',
        primary: '#22d3ee',    // cyan
        accent: '#f97316',     // orange
        secondary: '#ec4899',  // pink
        success: '#22c55e',
        error: '#ef4444',
        warning: '#eab308',
      },
    },
  },
}
#+END_SRC

*** TODO Install dependencies
#+BEGIN_SRC bash
npm install recharts lucide-react date-fns
npx shadcn@latest add card button badge table tabs scroll-area
#+END_SRC

** Phase 3: Dashboard Pages [0/4]
*** TODO Dashboard Overview (/)
- [ ] Stats cards: Total runs, Pass rate, Avg duration, Tests count
- [ ] Recent runs table with status badges
- [ ] Pass rate trend chart (last 30 days)
- [ ] Test execution time chart

*** TODO Run History (/runs)
- [ ] Paginated run list
- [ ] Filter by: status, date range, use case
- [ ] Search by run ID
- [ ] Quick stats per run

*** TODO Run Details (/runs/[id])
- [ ] Run metadata (ID, started, duration, status)
- [ ] Test list with expandable details
- [ ] Step timeline per test
- [ ] Assertion results with pass/fail badges
- [ ] Captured output/logs

*** TODO Live View (/live)
- [ ] SSE connection indicator
- [ ] Currently running test with progress
- [ ] Step-by-step updates in real-time
- [ ] Auto-scroll feed of completed tests
- [ ] Toast notifications for test completion

** Phase 4: Components [0/5]
*** TODO Layout components
- [ ] Sidebar with navigation (Dashboard, Runs, Live)
- [ ] Header with logo and status
- [ ] Dark theme wrapper

*** TODO Dashboard components
- [ ] StatsCard with icon, value, trend
- [ ] RecentRunsTable with status badges
- [ ] PassRateChart (area chart)
- [ ] DurationChart (bar chart)

*** TODO Run components
- [ ] RunCard with summary stats
- [ ] RunFilters (status, date, use case)
- [ ] TestAccordion with step details

*** TODO Test components
- [ ] StepTimeline (vertical timeline)
- [ ] AssertionBadge (pass/fail)
- [ ] LogViewer (code block with syntax)
- [ ] DurationBadge (formatted time)

*** TODO Live components
- [ ] ConnectionStatus indicator
- [ ] LiveTestCard (currently running)
- [ ] StepProgress (animated)
- [ ] CompletedTestFeed

** Phase 5: Integration [0/3]
*** TODO API client
#+BEGIN_SRC typescript
// lib/api.ts
const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:9999';

export async function getRuns(page = 1, limit = 20) {
  const res = await fetch(`${API_BASE}/api/runs?page=${page}&limit=${limit}`);
  return res.json();
}

export async function getRun(id: string) {
  const res = await fetch(`${API_BASE}/api/runs/${id}`);
  return res.json();
}

export async function getStats() {
  const res = await fetch(`${API_BASE}/api/stats`);
  return res.json();
}
#+END_SRC

*** TODO SSE hook
#+BEGIN_SRC typescript
// lib/sse.ts
import { useEffect, useState } from 'react';

export function useSSE(url: string) {
  const [events, setEvents] = useState<Event[]>([]);
  const [connected, setConnected] = useState(false);

  useEffect(() => {
    const eventSource = new EventSource(url);

    eventSource.onopen = () => setConnected(true);
    eventSource.onerror = () => setConnected(false);

    eventSource.onmessage = (e) => {
      const event = JSON.parse(e.data);
      setEvents(prev => [...prev, event]);
    };

    return () => eventSource.close();
  }, [url]);

  return { events, connected };
}
#+END_SRC

*** TODO Proxy configuration
#+BEGIN_SRC javascript
// next.config.js
module.exports = {
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: 'http://localhost:9999/api/:path*',
      },
    ];
  },
};
#+END_SRC

* API Specification

** GET /api/runs
#+BEGIN_SRC json
{
  "runs": [
    {
      "id": "abc-123",
      "started_at": "2026-01-19T10:00:00Z",
      "finished_at": "2026-01-19T10:05:00Z",
      "status": "completed",
      "total_tests": 29,
      "passed": 27,
      "failed": 2,
      "skipped": 0,
      "duration_ms": 300000
    }
  ],
  "total": 150,
  "page": 1,
  "limit": 20
}
#+END_SRC

** GET /api/runs/:id
#+BEGIN_SRC json
{
  "id": "abc-123",
  "started_at": "2026-01-19T10:00:00Z",
  "finished_at": "2026-01-19T10:05:00Z",
  "status": "completed",
  "config": {
    "cli_version": "0.8.0-beta.8",
    "docker_image": "tsuite-mesh:0.8.0-beta.8"
  },
  "tests": [
    {
      "id": "test-1",
      "test_id": "uc01_registry/tc01_agent_registration",
      "name": "Agent Registration",
      "status": "passed",
      "duration_ms": 47900,
      "steps": [
        {
          "index": 0,
          "handler": "shell",
          "status": "ok",
          "duration_ms": 1200,
          "output": "..."
        }
      ],
      "assertions": [
        {
          "expr": "...",
          "message": "...",
          "passed": true
        }
      ]
    }
  ]
}
#+END_SRC

** GET /api/stats
#+BEGIN_SRC json
{
  "total_runs": 150,
  "total_tests": 4350,
  "pass_rate": 0.93,
  "avg_duration_ms": 285000,
  "recent_trend": [
    { "date": "2026-01-18", "passed": 27, "failed": 2 },
    { "date": "2026-01-17", "passed": 28, "failed": 1 }
  ]
}
#+END_SRC

** SSE Events
#+BEGIN_SRC json
// run_started
{ "type": "run_started", "run_id": "abc-123", "total_tests": 29 }

// test_started
{ "type": "test_started", "run_id": "abc-123", "test_id": "uc01/tc01", "name": "..." }

// step_completed
{ "type": "step_completed", "run_id": "abc-123", "test_id": "uc01/tc01", "step": 0, "status": "ok" }

// test_completed
{ "type": "test_completed", "run_id": "abc-123", "test_id": "uc01/tc01", "status": "passed", "duration_ms": 47900 }

// run_completed
{ "type": "run_completed", "run_id": "abc-123", "passed": 27, "failed": 2 }
#+END_SRC

* UI Mockups

** Dashboard Overview
#+BEGIN_SRC
┌────────────────────────────────────────────────────────────────────┐
│ [Logo] tsuite                                    [Live] [Settings] │
├──────────┬─────────────────────────────────────────────────────────┤
│          │                                                         │
│ Dashboard│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│          │  │ 150      │ │ 93%      │ │ 4m 45s   │ │ 29       │   │
│ Runs     │  │ Total    │ │ Pass     │ │ Avg      │ │ Tests/   │   │
│          │  │ Runs     │ │ Rate     │ │ Duration │ │ Run      │   │
│ Live     │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
│          │                                                         │
│          │  ┌─────────────────────────────────────────────────┐   │
│          │  │            Pass Rate Trend (30 days)            │   │
│          │  │  ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄   │   │
│          │  └─────────────────────────────────────────────────┘   │
│          │                                                         │
│          │  Recent Runs                                            │
│          │  ┌─────────────────────────────────────────────────┐   │
│          │  │ ● abc-123  27/29 passed  4m 32s    10 min ago   │   │
│          │  │ ● def-456  29/29 passed  5m 01s    2 hours ago  │   │
│          │  │ ○ ghi-789  25/29 passed  4m 45s    yesterday    │   │
│          │  └─────────────────────────────────────────────────┘   │
└──────────┴─────────────────────────────────────────────────────────┘
#+END_SRC

** Live View
#+BEGIN_SRC
┌────────────────────────────────────────────────────────────────────┐
│ [Logo] tsuite                                    [Live] [Settings] │
├──────────┬─────────────────────────────────────────────────────────┤
│          │  ● Connected                          Run: abc-123      │
│ Dashboard│                                                         │
│          │  Currently Running                                      │
│ Runs     │  ┌─────────────────────────────────────────────────┐   │
│          │  │ uc03_capabilities/tc10_ts_capability_selector    │   │
│ Live ◉   │  │ ████████████░░░░░░░░  Step 12/20               │   │
│          │  │                                                  │   │
│          │  │ ✓ setup_environment     ✓ shell (copy)          │   │
│          │  │ ✓ shell (npm install)   ✓ shell (start)         │   │
│          │  │ ✓ wait (20s)            ● shell (call)  ←       │   │
│          │  └─────────────────────────────────────────────────┘   │
│          │                                                         │
│          │  Completed (15/29)                                      │
│          │  ┌─────────────────────────────────────────────────┐   │
│          │  │ ✓ tc01_agent_registration         47.9s         │   │
│          │  │ ✓ tc02_agent_discovery            40.5s         │   │
│          │  │ ✗ tc01_install_meshctl             6.4s         │   │
│          │  └─────────────────────────────────────────────────┘   │
└──────────┴─────────────────────────────────────────────────────────┘
#+END_SRC

* Implementation Notes

** Running the Dashboard

#+BEGIN_SRC bash
# Option 1: Run with tests (dashboard auto-starts)
cd integration
tsuite --all --docker --dashboard

# Option 2: Run standalone to view history
tsuite dashboard --port 3001

# Option 3: Development mode
cd dashboard
npm run dev
#+END_SRC

** Environment Variables
#+BEGIN_SRC bash
# .env.local
NEXT_PUBLIC_API_URL=http://localhost:9999
#+END_SRC

* Timeline Estimate

| Phase                | Effort   |
|----------------------+----------|
| Phase 1: Backend API | 1 day    |
| Phase 2: Next.js     | 0.5 day  |
| Phase 3: Pages       | 1.5 days |
| Phase 4: Components  | 1 day    |
| Phase 5: Integration | 0.5 day  |
|----------------------+----------|
| Total                | 4.5 days |

* References

- [[https://ui.shadcn.com/][shadcn/ui Documentation]]
- [[https://recharts.org/][Recharts Documentation]]
- [[https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events][MDN: Server-Sent Events]]
- [[https://nextjs.org/docs][Next.js Documentation]]
