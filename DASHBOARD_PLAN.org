#+TITLE: tsuite Dashboard Implementation Plan
#+AUTHOR: MCP Mesh Team
#+DATE: 2026-01-19
#+OPTIONS: toc:3 num:t

* Overview

Real-time test dashboard for tsuite with SSE streaming and historical run analysis.

** Design Theme
- Dark navy background (#0a1628)
- Cyan/teal primary (#22d3ee)
- Orange accent (#f97316)
- Pink/magenta secondary (#ec4899)
- Card containers with subtle borders
- Clean, modern typography

** Tech Stack
- Next.js 14 (App Router)
- Tailwind CSS
- shadcn/ui components
- Recharts for visualizations
- SSE for real-time updates

* Architecture

#+BEGIN_SRC
┌─────────────────────────────────────────────────────────────────┐
│                     dashboard/ (Next.js)                         │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌─────────────┐  │
│  │ Dashboard  │  │   Runs    │  │   Tests   │  │  Live View  │  │
│  │  Overview  │  │  History  │  │  Details  │  │   (SSE)     │  │
│  └───────────┘  └───────────┘  └───────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                               │
                          REST + SSE
                               │
┌─────────────────────────────────────────────────────────────────┐
│                     tsuite Backend                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  REST API   │  │  SSE Stream │  │  SQLite DB              │  │
│  │  /api/*     │  │  /events    │  │  (runs, tests, steps)   │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
#+END_SRC

* Directory Structure

#+BEGIN_SRC
mcp-mesh-test-suite/
├── tsuite/              # Existing framework
│   └── tsuite/
│       ├── api.py       # NEW: REST API endpoints
│       └── sse.py       # NEW: SSE event streaming
├── dashboard/           # NEW: Next.js frontend
│   ├── app/
│   │   ├── layout.tsx
│   │   ├── page.tsx           # Dashboard overview
│   │   ├── runs/
│   │   │   ├── page.tsx       # Run history
│   │   │   └── [id]/
│   │   │       └── page.tsx   # Run details
│   │   ├── live/
│   │   │   └── page.tsx       # Live test view
│   │   └── api/
│   │       └── [...proxy]/    # Proxy to tsuite backend
│   ├── components/
│   │   ├── ui/                # shadcn components
│   │   ├── layout/
│   │   │   ├── Sidebar.tsx
│   │   │   ├── Header.tsx
│   │   │   └── Logo.tsx
│   │   ├── dashboard/
│   │   │   ├── StatsCards.tsx
│   │   │   ├── RecentRuns.tsx
│   │   │   ├── PassRateChart.tsx
│   │   │   └── TestTrends.tsx
│   │   ├── runs/
│   │   │   ├── RunList.tsx
│   │   │   ├── RunCard.tsx
│   │   │   └── RunFilters.tsx
│   │   ├── tests/
│   │   │   ├── TestList.tsx
│   │   │   ├── TestCard.tsx
│   │   │   ├── StepTimeline.tsx
│   │   │   └── AssertionBadge.tsx
│   │   └── live/
│   │       ├── LiveFeed.tsx
│   │       ├── RunningTest.tsx
│   │       └── StepProgress.tsx
│   ├── lib/
│   │   ├── api.ts             # API client
│   │   ├── sse.ts             # SSE client hook
│   │   └── utils.ts
│   ├── public/
│   │   └── logo-cyan.svg      # MCP Mesh logo (copy from images/)
│   ├── package.json
│   ├── tailwind.config.ts
│   └── next.config.js
├── integration/         # Existing test suites
└── lib-tests/           # Existing lib tests
#+END_SRC

* Implementation Phases

** Phase 1: Backend API [3/4] :DONE:
*** DONE Add REST API to tsuite
CLOSED: [2026-01-19]
- [X] GET /api/runs - List all runs with pagination
- [X] GET /api/runs/:id - Get run details with tests
- [X] GET /api/runs/:id/tests - Get tests for a run
- [X] GET /api/runs/:id/tests/:test_id - Get test details with steps
- [X] GET /api/stats - Dashboard statistics
- [X] GET /api/stats/flaky - Flaky tests detection
- [X] GET /api/stats/slowest - Slowest tests
- [X] GET /api/compare/:id1/:id2 - Compare two runs

*** DONE Add SSE streaming endpoint
CLOSED: [2026-01-19]
- [X] GET /api/events - SSE stream for live updates (global)
- [X] GET /api/runs/:id/stream - SSE stream for specific run
- [X] Event types: run_started, test_started, test_completed, run_completed
- [X] Include test metadata in events
- [ ] step_completed events (future: requires executor refactor)

*** DONE Update tsuite CLI for SSE
CLOSED: [2026-01-19]
- [X] Emit SSE events during test execution (run/test lifecycle)
- [ ] Add --dashboard flag to enable API server (future)
- [ ] Add standalone dashboard command: tsuite dashboard [--port 3001] (future)

*** DONE Database schema updates
CLOSED: [2026-01-19]
- [X] step_results table for granular step tracking
- [X] captured_values table for captured output
- [X] stdout/stderr/error_message fields in step_results
- [X] Index optimization for dashboard queries

** Phase 2: Next.js Setup [3/3] :DONE:
*** DONE Initialize Next.js project
CLOSED: [2026-01-19]
#+BEGIN_SRC bash
cd mcp-mesh-test-suite
npx create-next-app@latest dashboard --typescript --tailwind --eslint --app --no-src-dir
cd dashboard
npx shadcn@latest init
#+END_SRC

*** DONE Configure Tailwind theme
CLOSED: [2026-01-19]
Custom dark navy theme configured in =app/globals.css= (Tailwind v4 CSS-based config):
- Background: #0a1628 (dark navy)
- Surface: #0f2744 (card backgrounds)
- Border: #1e3a5f (subtle borders)
- Primary: #22d3ee (cyan/teal)
- Accent: #f97316 (orange)
- Secondary: #ec4899 (pink/magenta)
- Success/Error/Warning colors configured
- Chart colors for Recharts

*** DONE Install dependencies
CLOSED: [2026-01-19]
#+BEGIN_SRC bash
npm install recharts lucide-react date-fns
npx shadcn@latest add card button badge table tabs scroll-area
#+END_SRC

Installed:
- recharts (charting)
- lucide-react (icons)
- date-fns (date formatting)
- shadcn/ui: card, button, badge, table, tabs, scroll-area

** Phase 3: Dashboard Pages [4/4] :DONE:
*** DONE Dashboard Overview (/)
CLOSED: [2026-01-19]
- [X] Stats cards: Total runs, Pass rate, Avg duration, Tests count
- [X] Recent runs table with status badges
- [X] Pass rate trend chart (area chart with gradient)
- [X] Responsive grid layout

*** DONE Run History (/runs)
CLOSED: [2026-01-19]
- [X] Run list with status indicators
- [X] Filter by: status (all, completed, failed, running)
- [X] Run cards with pass/fail counts, duration
- [X] Quick navigation to run details

*** DONE Run Details (/runs/[id])
CLOSED: [2026-01-19]
- [X] Run metadata (ID, started, duration, status, CLI version, docker image)
- [X] Test list with expandable details
- [X] Tabs for All/Passed/Failed tests
- [X] Error message display for failed tests
- [X] Test metadata display

*** DONE Live View (/live)
CLOSED: [2026-01-19]
- [X] SSE connection indicator (connected/disconnected)
- [X] Currently running test card with spinner
- [X] Run events panel (run_started, run_completed)
- [X] Auto-updating completed tests feed
- [X] Real-time event streaming via useSSE hook

** Phase 4: Components [5/5] :DONE:
*** DONE Layout components
CLOSED: [2026-01-19]
- [X] Sidebar with navigation (Dashboard, Runs, Live) - =components/layout/Sidebar.tsx=
- [X] Header with connection status and current run indicator - =components/layout/Header.tsx=
- [X] Dark theme wrapper (via globals.css and html class="dark")

*** DONE Dashboard components
CLOSED: [2026-01-19]
- [X] StatsCards with icons, values - =components/dashboard/StatsCards.tsx=
- [X] RecentRuns table with status badges - =components/dashboard/RecentRuns.tsx=
- [X] PassRateChart (area chart with gradient) - =components/dashboard/PassRateChart.tsx=

*** DONE Run components
CLOSED: [2026-01-19]
- [X] RunsList with status filtering - =app/runs/RunsList.tsx=
- [X] RunDetails with test list - =app/runs/[id]/RunDetails.tsx=
- [X] TestList with expandable details

*** DONE Test components
CLOSED: [2026-01-19]
- [X] Test cards with status icons
- [X] Error message display
- [X] Duration badges (formatDuration utility)
- [X] Tag badges

*** DONE Live components
CLOSED: [2026-01-19]
- [X] ConnectionStatus indicator - =app/live/LiveFeed.tsx=
- [X] Running test card with spinner
- [X] Run events panel
- [X] CompletedTestFeed with scroll area

** Phase 5: Integration [3/3] :DONE:
*** DONE API client
CLOSED: [2026-01-19]
#+BEGIN_SRC typescript
// lib/api.ts
const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:9999';

export async function getRuns(page = 1, limit = 20) {
  const res = await fetch(`${API_BASE}/api/runs?page=${page}&limit=${limit}`);
  return res.json();
}

export async function getRun(id: string) {
  const res = await fetch(`${API_BASE}/api/runs/${id}`);
  return res.json();
}

export async function getStats() {
  const res = await fetch(`${API_BASE}/api/stats`);
  return res.json();
}
#+END_SRC

*** DONE SSE hook
CLOSED: [2026-01-19]
Implemented in =lib/sse.ts= with:
- =useSSE= hook with options (runId, onEvent, maxEvents)
- =useRunStream= for specific run events
- =useLiveEvents= for global event stream
- Connection status tracking
- Event type definitions (SSEEvent interface)

*** DONE Proxy configuration
CLOSED: [2026-01-19]
Configured in =next.config.ts=:
#+BEGIN_SRC typescript
async rewrites() {
  return [
    {
      source: "/api/:path*",
      destination: `${process.env.NEXT_PUBLIC_API_URL || "http://localhost:9999"}/api/:path*`,
    },
  ];
}
#+END_SRC

* API Specification

** GET /api/runs
#+BEGIN_SRC json
{
  "runs": [
    {
      "id": "abc-123",
      "started_at": "2026-01-19T10:00:00Z",
      "finished_at": "2026-01-19T10:05:00Z",
      "status": "completed",
      "total_tests": 29,
      "passed": 27,
      "failed": 2,
      "skipped": 0,
      "duration_ms": 300000
    }
  ],
  "total": 150,
  "page": 1,
  "limit": 20
}
#+END_SRC

** GET /api/runs/:id
#+BEGIN_SRC json
{
  "id": "abc-123",
  "started_at": "2026-01-19T10:00:00Z",
  "finished_at": "2026-01-19T10:05:00Z",
  "status": "completed",
  "config": {
    "cli_version": "0.8.0-beta.8",
    "docker_image": "tsuite-mesh:0.8.0-beta.8"
  },
  "tests": [
    {
      "id": "test-1",
      "test_id": "uc01_registry/tc01_agent_registration",
      "name": "Agent Registration",
      "status": "passed",
      "duration_ms": 47900,
      "steps": [
        {
          "index": 0,
          "handler": "shell",
          "status": "ok",
          "duration_ms": 1200,
          "output": "..."
        }
      ],
      "assertions": [
        {
          "expr": "...",
          "message": "...",
          "passed": true
        }
      ]
    }
  ]
}
#+END_SRC

** GET /api/stats
#+BEGIN_SRC json
{
  "total_runs": 150,
  "total_tests": 4350,
  "pass_rate": 0.93,
  "avg_duration_ms": 285000,
  "recent_trend": [
    { "date": "2026-01-18", "passed": 27, "failed": 2 },
    { "date": "2026-01-17", "passed": 28, "failed": 1 }
  ]
}
#+END_SRC

** SSE Events
#+BEGIN_SRC json
// run_started
{ "type": "run_started", "run_id": "abc-123", "total_tests": 29 }

// test_started
{ "type": "test_started", "run_id": "abc-123", "test_id": "uc01/tc01", "name": "..." }

// step_completed
{ "type": "step_completed", "run_id": "abc-123", "test_id": "uc01/tc01", "step": 0, "status": "ok" }

// test_completed
{ "type": "test_completed", "run_id": "abc-123", "test_id": "uc01/tc01", "status": "passed", "duration_ms": 47900 }

// run_completed
{ "type": "run_completed", "run_id": "abc-123", "passed": 27, "failed": 2 }
#+END_SRC

* UI Mockups

** Dashboard Overview
#+BEGIN_SRC
┌────────────────────────────────────────────────────────────────────┐
│ [Logo] tsuite                                    [Live] [Settings] │
├──────────┬─────────────────────────────────────────────────────────┤
│          │                                                         │
│ Dashboard│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│          │  │ 150      │ │ 93%      │ │ 4m 45s   │ │ 29       │   │
│ Runs     │  │ Total    │ │ Pass     │ │ Avg      │ │ Tests/   │   │
│          │  │ Runs     │ │ Rate     │ │ Duration │ │ Run      │   │
│ Live     │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
│          │                                                         │
│          │  ┌─────────────────────────────────────────────────┐   │
│          │  │            Pass Rate Trend (30 days)            │   │
│          │  │  ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄   │   │
│          │  └─────────────────────────────────────────────────┘   │
│          │                                                         │
│          │  Recent Runs                                            │
│          │  ┌─────────────────────────────────────────────────┐   │
│          │  │ ● abc-123  27/29 passed  4m 32s    10 min ago   │   │
│          │  │ ● def-456  29/29 passed  5m 01s    2 hours ago  │   │
│          │  │ ○ ghi-789  25/29 passed  4m 45s    yesterday    │   │
│          │  └─────────────────────────────────────────────────┘   │
└──────────┴─────────────────────────────────────────────────────────┘
#+END_SRC

** Live View
#+BEGIN_SRC
┌────────────────────────────────────────────────────────────────────┐
│ [Logo] tsuite                                    [Live] [Settings] │
├──────────┬─────────────────────────────────────────────────────────┤
│          │  ● Connected                          Run: abc-123      │
│ Dashboard│                                                         │
│          │  Currently Running                                      │
│ Runs     │  ┌─────────────────────────────────────────────────┐   │
│          │  │ uc03_capabilities/tc10_ts_capability_selector    │   │
│ Live ◉   │  │ ████████████░░░░░░░░  Step 12/20               │   │
│          │  │                                                  │   │
│          │  │ ✓ setup_environment     ✓ shell (copy)          │   │
│          │  │ ✓ shell (npm install)   ✓ shell (start)         │   │
│          │  │ ✓ wait (20s)            ● shell (call)  ←       │   │
│          │  └─────────────────────────────────────────────────┘   │
│          │                                                         │
│          │  Completed (15/29)                                      │
│          │  ┌─────────────────────────────────────────────────┐   │
│          │  │ ✓ tc01_agent_registration         47.9s         │   │
│          │  │ ✓ tc02_agent_discovery            40.5s         │   │
│          │  │ ✗ tc01_install_meshctl             6.4s         │   │
│          │  └─────────────────────────────────────────────────┘   │
└──────────┴─────────────────────────────────────────────────────────┘
#+END_SRC

* Implementation Notes

** Running the Dashboard

#+BEGIN_SRC bash
# Option 1: Run with tests (dashboard auto-starts)
cd integration
tsuite --all --docker --dashboard

# Option 2: Run standalone to view history
tsuite dashboard --port 3001

# Option 3: Development mode
cd dashboard
npm run dev
#+END_SRC

** Environment Variables
#+BEGIN_SRC bash
# .env.local
NEXT_PUBLIC_API_URL=http://localhost:9999
#+END_SRC

* Timeline Estimate

| Phase                | Effort   |
|----------------------+----------|
| Phase 1: Backend API | 1 day    |
| Phase 2: Next.js     | 0.5 day  |
| Phase 3: Pages       | 1.5 days |
| Phase 4: Components  | 1 day    |
| Phase 5: Integration | 0.5 day  |
|----------------------+----------|
| Total                | 4.5 days |

* References

- [[https://ui.shadcn.com/][shadcn/ui Documentation]]
- [[https://recharts.org/][Recharts Documentation]]
- [[https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events][MDN: Server-Sent Events]]
- [[https://nextjs.org/docs][Next.js Documentation]]
