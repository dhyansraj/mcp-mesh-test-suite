# Test Case: Tool Call Tracing with Distributed Tracing
# Verifies that tool calls across multiple agents produce traceable spans
#
# Agent Setup:
#   - py-math-agent (port 9000): provides "add" capability
#   - ts-math-agent (port 9013): provides "multiply" and "add" capabilities
#   - py-calculator (port 9022): provides "calculate" that depends on add+multiply
#
# Flow: calculate -> add (repeated) -> multiply -> result
# Uses UC-level artifacts from /uc-artifacts

name: "Tool Call Tracing"
description: "Verify distributed tracing works across multi-agent tool calls"
tags:
  - observability
  - tracing
  - tempo
  - redis
timeout: 180

pre_run:
  # Start observability infrastructure (Redis + Tempo)
  - routine: global.start_observability

  # Setup for Python agents
  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

test:
  # Copy UC-level artifacts to workspace
  - name: "Copy artifacts to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/py-math-agent /workspace/
      cp -r /uc-artifacts/ts-math-agent /workspace/
      cp -r /uc-artifacts/py-calculator /workspace/
      cp /uc-artifacts/.env /workspace/
      echo "Artifacts copied"
      ls -la /workspace/
    capture: copy_output

  # Install npm dependencies for ts-math-agent
  - name: "Install npm dependencies"
    handler: npm-install
    path: /workspace/ts-math-agent

  # Start py-math-agent with tracing enabled
  - name: "Start py-math-agent"
    handler: shell
    command: "meshctl start py-math-agent/main.py --env-file .env -d"
    workdir: /workspace
    capture: start_py_math

  # Start ts-math-agent with tracing enabled
  - name: "Start ts-math-agent"
    handler: shell
    command: "meshctl start ts-math-agent/src/index.ts --env-file .env -d"
    workdir: /workspace
    capture: start_ts_math

  # Start py-calculator with tracing enabled
  - name: "Start py-calculator"
    handler: shell
    command: "meshctl start py-calculator/main.py --env-file .env -d"
    workdir: /workspace
    capture: start_py_calc

  # Wait for all agents to register
  - name: "Wait for registration"
    handler: wait
    seconds: 15

  # Verify all agents are running
  - name: "List agents"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: list_output

  # List tools to verify capabilities
  - name: "List tools"
    handler: shell
    command: "meshctl list -t"
    workdir: /workspace
    capture: tools_output

  # Call calculate with --trace to generate distributed trace
  - name: "Call calculate with tracing"
    handler: shell
    command: |
      meshctl call calculate '{"a": 7, "b": 6}' --trace 2>&1
    workdir: /workspace
    capture: calculate_output
    timeout: 60

  # Extract trace ID from output
  - name: "Extract trace ID"
    handler: shell
    command: |
      # Extract trace ID from "Trace ID: <id>" line
      TRACE_ID=$(echo "${captured.calculate_output}" | grep "Trace ID:" | awk '{print $3}')
      if [ -z "$TRACE_ID" ]; then
        echo "ERROR: Could not extract trace ID"
        echo "Output was: ${captured.calculate_output}"
        exit 1
      fi
      echo "TRACE_ID=$TRACE_ID"
    workdir: /workspace
    capture: trace_id_output

  # Wait for traces to be flushed to Tempo
  - name: "Wait for trace flush"
    handler: wait
    seconds: 5

  # Query trace from Tempo (capture only JSON output)
  - name: "Query trace from Tempo"
    handler: shell
    command: |
      TRACE_ID=$(echo "${captured.trace_id_output}" | grep "TRACE_ID=" | cut -d= -f2)
      meshctl trace $TRACE_ID --json 2>&1
    workdir: /workspace
    capture: trace_output
    timeout: 30

  # Stop all agents
  - name: "Stop agents"
    handler: shell
    command: "meshctl stop"
    workdir: /workspace

assertions:
  # All agents should be registered
  - expr: "${captured.list_output} contains 'py-math-agent'"
    message: "py-math-agent should be registered"

  - expr: "${captured.list_output} contains 'ts-math-agent'"
    message: "ts-math-agent should be registered"

  - expr: "${captured.list_output} contains 'py-calculator'"
    message: "py-calculator should be registered"

  # Tools should be available
  - expr: "${captured.tools_output} contains 'calculate'"
    message: "calculate tool should be listed"

  - expr: "${captured.tools_output} contains 'add'"
    message: "add tool should be listed"

  - expr: "${captured.tools_output} contains 'multiply'"
    message: "multiply tool should be listed"

  # Calculate should return correct result (7 * 6 = 42)
  - expr: "${captured.calculate_output} contains '42'"
    message: "Calculate should return 42 (7 * 6)"

  # Trace ID should be extracted
  - expr: "${captured.trace_id_output} contains 'TRACE_ID='"
    message: "Trace ID should be extracted from output"

  # Trace should have correct span count (15 spans for calculate with 6 adds + 1 multiply)
  - expr: ${jq:captured.trace_output:.SpanCount} == 15
    message: "Trace should have exactly 15 spans"

  # Trace should involve 2 agents
  - expr: ${jq:captured.trace_output:.AgentCount} == 2
    message: "Trace should involve 2 agents (py-calculator, ts-math-agent)"

  # Trace should be successful
  - expr: ${jq:captured.trace_output:.Success} == true
    message: "Trace should show successful execution"

post_run:
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.stop_observability
  - routine: global.cleanup_workspace
