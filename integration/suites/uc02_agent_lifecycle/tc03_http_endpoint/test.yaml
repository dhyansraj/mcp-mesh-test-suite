# Test Case: Agent HTTP Endpoint
# Verifies that an agent's HTTP endpoints work correctly

name: "Agent HTTP Endpoint"
description: "Test agent HTTP endpoints respond correctly"
tags:
  - lifecycle
  - python
  - http
  - api
timeout: 300

pre_run:
  # Setup for Python agent (venv + meshctl + mcpmesh SDK)
  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

test:
  # Scaffold a test agent
  - handler: shell
    command: "meshctl scaffold --name http-agent --agent-type tool --lang python"
    workdir: /workspace

  # Start agent with meshctl (detached mode, custom port)
  - handler: shell
    command: "meshctl start http-agent/main.py --env MCP_MESH_HTTP_PORT=3003 -d"
    workdir: /workspace
    capture: start_output

  # Wait for agent to start
  - handler: wait
    seconds: 5

  # Check if agent is running
  - handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: list_output

  # Test MCP endpoint with tools/list request
  - handler: shell
    command: |
      python3 -c "
      import requests
      try:
          r = requests.post('http://localhost:3003/mcp',
                            json={'jsonrpc':'2.0','method':'tools/list','id':1,'params':{}},
                            headers={'Accept': 'application/json, text/event-stream'},
                            timeout=10)
          print(f'Status: {r.status_code}')
          print(f'Response: {r.text[:2000]}')
      except Exception as e:
          print(f'Error: {e}')
      "
    capture: tools_response

  # Get agent logs for debugging
  - handler: shell
    command: "meshctl logs http-agent 2>/dev/null | tail -30 || echo 'no logs'"
    workdir: /workspace
    capture: agent_logs

  # Stop agent
  - handler: shell
    command: "meshctl stop"
    workdir: /workspace

assertions:
  # Agent appears in meshctl list
  - expr: ${captured.list_output} contains 'http-agent'
    message: "Agent should appear in meshctl list"

  # Tools list returns valid JSON-RPC response
  - expr: ${captured.tools_response} contains 'jsonrpc'
    message: "Tools endpoint should return JSON-RPC response"

  # Check for tools in response
  - expr: ${captured.tools_response} contains 'tools'
    message: "Response should contain tools list"

post_run:
  # Stop any remaining agents
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
