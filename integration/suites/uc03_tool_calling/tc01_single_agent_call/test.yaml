# Test Case: Single Agent Tool Call
# Verifies that meshctl call can invoke tools on a running agent

name: "Single Agent Tool Call"
description: "Test calling tools on a math agent using meshctl call"
tags:
  - tool_calling
  - python
  - meshctl
timeout: 300

pre_run:
  # Setup for Python agent (venv + meshctl + mcpmesh SDK)
  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

test:
  # Copy artifacts to workspace (artifacts auto-mounted at /artifacts)
  - handler: shell
    command: "cp -r /artifacts/* /workspace/"
    capture: copy_output

  # Verify math-agent was copied
  - handler: shell
    command: "ls -la /workspace/math-agent/"
    capture: ls_output

  # Start the math-agent with meshctl
  - handler: shell
    command: "meshctl start math-agent/main.py --env MCP_MESH_HTTP_PORT=3010 -d"
    workdir: /workspace
    capture: start_output

  # Wait for agent to start
  - handler: wait
    seconds: 5

  # Verify agent is running
  - handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: list_output

  # Test add tool: 5 + 3 = 8
  - handler: shell
    command: "meshctl call add '{\"a\": 5, \"b\": 3}'"
    workdir: /workspace
    capture: add_result

  # Test subtract tool: 10 - 4 = 6
  - handler: shell
    command: "meshctl call subtract '{\"a\": 10, \"b\": 4}'"
    workdir: /workspace
    capture: subtract_result

  # Test multiply tool: 7 * 6 = 42
  - handler: shell
    command: "meshctl call multiply '{\"a\": 7, \"b\": 6}'"
    workdir: /workspace
    capture: multiply_result

  # Test divide tool: 20 / 4 = 5
  - handler: shell
    command: "meshctl call divide '{\"a\": 20, \"b\": 4}'"
    workdir: /workspace
    capture: divide_result

  # Get agent logs for debugging
  - handler: shell
    command: "meshctl logs math-agent 2>/dev/null | tail -30 || echo 'no logs'"
    workdir: /workspace
    capture: agent_logs

  # Stop agent
  - handler: shell
    command: "meshctl stop"
    workdir: /workspace

assertions:
  # Agent started successfully
  - expr: ${captured.list_output} contains 'math-agent'
    message: "math-agent should appear in meshctl list"

  # add(5, 3) = 8
  - expr: ${captured.add_result} contains '8'
    message: "add(5, 3) should return 8"

  # subtract(10, 4) = 6
  - expr: ${captured.subtract_result} contains '6'
    message: "subtract(10, 4) should return 6"

  # multiply(7, 6) = 42
  - expr: ${captured.multiply_result} contains '42'
    message: "multiply(7, 6) should return 42"

  # divide(20, 4) = 5
  - expr: ${captured.divide_result} contains '5'
    message: "divide(20, 4) should return 5"

post_run:
  # Stop any remaining agents
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
