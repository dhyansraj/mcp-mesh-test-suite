# Test Case: Tag Matching - Preferred
# Tests that consumer preferring a tag selects the matching provider.
#
# Scenario:
#   - py-fast-provider has tags ["api", "fast"]
#   - py-accurate-provider has tags ["api", "accurate"]
#   - Consumer prefers ["+fast"]
#   - Should select fast-provider over accurate-provider
#
# Uses UC-level artifacts from /uc-artifacts

name: "Tag Matching - Preferred"
description: "Verify consumer preferring tag selects matching provider"
tags:
  - capabilities
  - tags
  - preferred
timeout: 180

pre_run:
  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

test:
  # Copy artifacts
  - name: "Copy artifacts to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/py-fast-provider /workspace/
      cp -r /uc-artifacts/py-accurate-provider /workspace/
      cp -r /uc-artifacts/py-tag-consumer /workspace/
    capture: copy_output

  # Start both providers
  - name: "Start fast provider"
    handler: shell
    command: "meshctl start py-fast-provider/main.py -d"
    workdir: /workspace
    capture: start_fast

  - name: "Start accurate provider"
    handler: shell
    command: "meshctl start py-accurate-provider/main.py -d"
    workdir: /workspace
    capture: start_accurate

  - name: "Wait for providers registration"
    handler: wait
    seconds: 10

  # Start consumer
  - name: "Start consumer"
    handler: shell
    command: "meshctl start py-tag-consumer/main.py -d"
    workdir: /workspace
    capture: start_consumer

  - name: "Wait for consumer registration"
    handler: wait
    seconds: 10

  # Verify all agents registered
  - name: "Verify all agents registered"
    handler: shell
    command: |
      meshctl list
      count=$(meshctl list 2>/dev/null | grep -c "provider\|consumer" || echo "0")
      echo "Agent count: $count"
    workdir: /workspace
    capture: list_output

  # Call fetch_prefer_fast which prefers "+fast"
  - name: "Call fetch_prefer_fast with preferred tag"
    handler: shell
    command: |
      RESULT=$(meshctl call fetch_prefer_fast '{"query": "test"}' 2>&1)
      echo "Result: $RESULT"
      # Should prefer fast-provider due to +fast tag
      if echo "$RESULT" | grep -q "FAST"; then
        echo "PASS: Selected provider with preferred 'fast' tag"
      else
        echo "FAIL: Expected FAST provider to be preferred"
        echo "Got: $RESULT"
        exit 1
      fi
    workdir: /workspace
    capture: call_preferred

assertions:
  - expr: "${captured.list_output} contains 'py-fast-provider'"
    message: "Fast provider should be registered"

  - expr: "${captured.list_output} contains 'py-accurate-provider'"
    message: "Accurate provider should be registered"

  - expr: "${captured.call_preferred} contains 'PASS'"
    message: "Should select provider with preferred tag"

post_run:
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
