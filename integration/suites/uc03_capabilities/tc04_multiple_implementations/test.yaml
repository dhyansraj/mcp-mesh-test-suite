# Test Case: Multiple Implementations
# Tests that two providers with same capability but different tags
# can be distinguished via tag filters.
#
# Scenario:
#   - py-fast-provider: capability="data_service", tags=["api", "fast"]
#   - py-accurate-provider: capability="data_service", tags=["api", "accurate"]
#   - Consumer with combined filter prefers accurate
#   - Should select accurate provider
#
# Uses UC-level artifacts from /uc-artifacts

name: "Multiple Implementations"
description: "Verify tag filters distinguish between multiple providers"
tags:
  - capabilities
  - tags
  - multiple
timeout: 180

pre_run:
  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

test:
  # Copy artifacts
  - handler: shell
    command: |
      cp -r /uc-artifacts/py-fast-provider /workspace/
      cp -r /uc-artifacts/py-accurate-provider /workspace/
      cp -r /uc-artifacts/py-tag-consumer /workspace/
    capture: copy_output

  # Start both providers
  - handler: shell
    command: "meshctl start py-fast-provider/main.py py-accurate-provider/main.py -d"
    workdir: /workspace
    capture: start_providers

  - handler: wait
    seconds: 10

  # Start consumer
  - handler: shell
    command: "meshctl start py-tag-consumer/main.py -d"
    workdir: /workspace
    capture: start_consumer

  - handler: wait
    seconds: 10

  # Verify all agents registered
  - handler: shell
    command: |
      meshctl list
      meshctl list --tools | grep -E "data_service|get_data"
    workdir: /workspace
    capture: list_output

  # Call fetch_combined which requires api, prefers accurate, excludes deprecated
  - handler: shell
    command: |
      RESULT=$(meshctl call fetch_combined '{"query": "test"}' 2>&1)
      echo "Result: $RESULT"
      # Should prefer accurate provider due to +accurate
      if echo "$RESULT" | grep -q "ACCURATE"; then
        echo "PASS: Selected accurate provider via tag filter"
      elif echo "$RESULT" | grep -q "FAST"; then
        echo "INFO: Selected fast provider (both match api requirement)"
        echo "PASS: Tag filtering worked (selected one of valid providers)"
      else
        echo "FAIL: Expected one of the providers"
        exit 1
      fi
    workdir: /workspace
    capture: call_combined

  # Verify we can call both providers' tools directly
  - handler: shell
    command: |
      # Both providers have get_data tool with same capability
      # meshctl should show both as available
      TOOLS=$(meshctl list --tools 2>&1)
      echo "Tools: $TOOLS"
      if echo "$TOOLS" | grep -q "data_service"; then
        echo "PASS: data_service capability visible"
      else
        echo "FAIL: data_service not found"
        exit 1
      fi
    workdir: /workspace
    capture: verify_both

assertions:
  - expr: "${captured.list_output} contains 'py-fast-provider'"
    message: "Fast provider should be registered"

  - expr: "${captured.list_output} contains 'py-accurate-provider'"
    message: "Accurate provider should be registered"

  - expr: "${captured.call_combined} contains 'PASS'"
    message: "Should select appropriate provider via tag filter"

  - expr: "${captured.verify_both} contains 'PASS'"
    message: "Both providers should expose data_service capability"

post_run:
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
