# Test Case: TypeScript Capability Selector OR Logic
# Tests that multiple matching TS providers all satisfy the dependency.
#
# Uses UC-level artifacts from /uc-artifacts
#
# NOTE: Uses `meshctl stop --agents` to keep registry running during stop/restart
# cycles. This avoids stale DB entries from agents that weren't properly unregistered.

name: "TypeScript Capability Selector OR Logic"
description: "Verify any matching TS provider satisfies dependency"
tags:
  - capabilities
  - tags
  - or-logic
  - typescript
timeout: 300

pre_run:
  # TypeScript-only test - just need Node.js + meshctl (no Python venv)
  - routine: global.setup_environment
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Copy and setup TypeScript artifacts
  - name: "Copy and setup TypeScript artifacts"
    handler: shell
    command: |
      cp -r /uc-artifacts/ts-fast-provider /workspace/
      cp -r /uc-artifacts/ts-accurate-provider /workspace/
      cp -r /uc-artifacts/ts-tag-consumer /workspace/
      VERSION="${config.packages.sdk_typescript_version}"
      sed -i "s/__SDK_VERSION__/$VERSION/g" /workspace/ts-fast-provider/package.json
      sed -i "s/__SDK_VERSION__/$VERSION/g" /workspace/ts-accurate-provider/package.json
      sed -i "s/__SDK_VERSION__/$VERSION/g" /workspace/ts-tag-consumer/package.json
    capture: copy_output

  # Install npm dependencies for all TS agents
  - name: "Install npm dependencies for all TS agents"
    handler: shell
    command: "cd ts-fast-provider && npm install --silent && cd ../ts-accurate-provider && npm install --silent && cd ../ts-tag-consumer && npm install --silent"
    workdir: /workspace
    timeout: 180

  # === TEST 1: Only fast provider available ===
  - name: "Test 1: Start fast provider only"
    handler: shell
    command: "meshctl start ts-fast-provider/src/index.ts -d"
    workdir: /workspace
    capture: start_fast_only

  - name: "Wait for fast provider registration"
    handler: wait
    seconds: 20

  - name: "Test 1: Start consumer"
    handler: shell
    command: "meshctl start ts-tag-consumer/src/index.ts -d"
    workdir: /workspace
    capture: start_consumer_1

  - name: "Wait for consumer registration"
    handler: wait
    seconds: 20

  - name: "Test 1: Call fetch_required with only fast available"
    handler: shell
    command: |
      echo "=== DEBUG: Before call ==="
      meshctl list 2>&1 || echo "meshctl list failed"
      echo "=== DEBUG: Calling fetch_required ==="
      RESULT=$(meshctl call fetch_required '{"query": "test1"}' 2>&1)
      echo "With only fast: $RESULT"
      if echo "$RESULT" | grep -q "TS_FAST"; then
        echo "PASS: Matched TS fast when only fast available"
      elif echo "$RESULT" | grep -q "NO_PROVIDER"; then
        echo "FAIL: Got NO_PROVIDER - dependency not injected"
        exit 1
      else
        echo "FAIL: Should match fast provider"
        echo "Full result: $RESULT"
        exit 1
      fi
    workdir: /workspace
    capture: test_fast_only

  # Stop agents but keep registry running (avoids stale DB entries)
  - name: "Stop agents (keep registry running)"
    handler: shell
    command: "meshctl stop --agents 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true

  - name: "Wait for cleanup"
    handler: wait
    seconds: 5

  # === TEST 2: Only accurate provider available ===
  # Debug: Check registry state before starting
  - name: "Debug: Check registry state before test 2"
    handler: shell
    command: "meshctl list 2>&1 || echo 'No agents registered'"
    workdir: /workspace
    capture: debug_before_test2

  - name: "Test 2: Start accurate provider only"
    handler: shell
    command: "meshctl start ts-accurate-provider/src/index.ts -d"
    workdir: /workspace
    capture: start_accurate_only

  - name: "Wait for accurate provider registration"
    handler: wait
    seconds: 25

  - name: "Test 2: Start consumer"
    handler: shell
    command: "meshctl start ts-tag-consumer/src/index.ts -d"
    workdir: /workspace
    capture: start_consumer_2

  # Wait longer for registry to clear stale agents (heartbeat interval is 5s)
  - name: "Wait for registry to clear stale agents"
    handler: wait
    seconds: 25

  # Debug: Check registry state before call
  - name: "Debug: Check registry state before call"
    handler: shell
    command: "meshctl list 2>&1"
    workdir: /workspace
    capture: debug_list_test2

  - name: "Test 2: Call fetch_required with only accurate available"
    handler: shell
    command: |
      RESULT=$(meshctl call fetch_required '{"query": "test2"}' 2>&1)
      echo "With only accurate: $RESULT"
      if echo "$RESULT" | grep -q "TS_ACCURATE"; then
        echo "PASS: Matched TS accurate when only accurate available"
      else
        echo "FAIL: Should match accurate provider"
        echo "DEBUG: Result was: $RESULT"
        exit 1
      fi
    workdir: /workspace
    capture: test_accurate_only

  # Stop agents but keep registry running
  - name: "Stop agents (keep registry running)"
    handler: shell
    command: "meshctl stop --agents 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true

  - name: "Wait for cleanup"
    handler: wait
    seconds: 5

  # === TEST 3: Both providers available ===
  - name: "Test 3: Start both providers"
    handler: shell
    command: "meshctl start ts-fast-provider/src/index.ts ts-accurate-provider/src/index.ts -d"
    workdir: /workspace
    capture: start_both

  - name: "Wait for providers registration"
    handler: wait
    seconds: 25

  - name: "Test 3: Start consumer"
    handler: shell
    command: "meshctl start ts-tag-consumer/src/index.ts -d"
    workdir: /workspace
    capture: start_consumer_3

  # Wait longer for registry to clear stale agents
  - name: "Wait for registry to clear stale agents"
    handler: wait
    seconds: 25

  - name: "Test 3: Call fetch_required with both available"
    handler: shell
    command: |
      RESULT=$(meshctl call fetch_required '{"query": "test3"}' 2>&1)
      echo "With both: $RESULT"
      if echo "$RESULT" | grep -q "TS_FAST\|TS_ACCURATE"; then
        echo "PASS: Matched one of the TS providers when both available"
      else
        echo "FAIL: Should match one of the providers"
        exit 1
      fi
    workdir: /workspace
    capture: test_both

assertions:
  - expr: "${captured.test_fast_only} contains 'PASS'"
    message: "Should match TS fast when only fast available"

  - expr: "${captured.test_accurate_only} contains 'PASS'"
    message: "Should match TS accurate when only accurate available"

  - expr: "${captured.test_both} contains 'PASS'"
    message: "Should match one TS provider when both available"

post_run:
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
