# Test Case: Gemini Provider TypeScript - Message Format
# Verifies Gemini TS provider handles message format correctly without errors
# Related Issue: https://github.com/dhyansraj/mcp-mesh/issues/461

name: "Gemini Provider TS - Format"
description: "Verify Gemini TypeScript provider handles message format without AI_InvalidPromptError"
tags:
  - llm
  - gemini
  - typescript
  - format
timeout: 180

# Note: Skip this test with --skip-tag llm if no API key is available

pre_run:
  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

test:
  # Copy UC-level Gemini TS provider artifacts
  - name: "Copy Gemini TS provider to workspace"
    handler: shell
    command: "cp -r /uc-artifacts/gemini-provider-ts /workspace/"
    capture: copy_provider_output

  # Copy TC-level llm-agent artifacts
  - name: "Copy llm-agent to workspace"
    handler: shell
    command: "cp -r /artifacts/llm-agent /workspace/"
    capture: copy_agent_output

  # Copy .env file from UC artifacts
  - name: "Copy env file"
    handler: shell
    command: "cp /uc-artifacts/.env /workspace/"
    capture: copy_env_output

  # Verify workspace files
  - name: "Verify workspace files"
    handler: shell
    command: "ls -la /workspace/"
    capture: ls_output

  # Install npm dependencies for Gemini TS provider
  - name: "Install Gemini TS provider dependencies"
    handler: npm-install
    path: /workspace/gemini-provider-ts

  # Start Gemini TS provider first
  - name: "Start Gemini TS provider"
    handler: shell
    command: "meshctl start gemini-provider-ts/src/index.ts --env-file .env -d"
    workdir: /workspace
    capture: start_provider_output

  # Wait for provider to register
  - name: "Wait for provider to register"
    handler: wait
    seconds: 8

  # Verify provider is running
  - name: "Verify provider is running"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: provider_list_output

  # Start llm-agent (depends on gemini-provider-ts)
  - name: "Start llm-agent"
    handler: shell
    command: "meshctl start llm-agent/main.py -d"
    workdir: /workspace
    capture: start_agent_output

  # Wait for agent to register and resolve dependencies
  - name: "Wait for agent to register"
    handler: wait
    seconds: 5

  # Verify both are running
  - name: "Verify all agents running"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: all_list_output

  # List available tools
  - name: "List available tools"
    handler: shell
    command: "meshctl list -t"
    workdir: /workspace
    capture: tools_output

  # Call llm_agent_gemini_ts with a question
  - name: "Call llm_agent_gemini_ts - capital of France"
    handler: shell
    command: |
      meshctl call llm_agent_gemini_ts '{"ctx": {"question": "What is the capital of France?"}}'
    workdir: /workspace
    capture: llm_response

  # Stop all agents
  - name: "Stop all agents"
    handler: shell
    command: "meshctl stop"
    workdir: /workspace

assertions:
  # Provider started successfully
  - expr: ${captured.provider_list_output} contains 'gemini-provider-ts'
    message: "gemini-provider-ts should appear in meshctl list"

  # Agent started successfully
  - expr: ${captured.all_list_output} contains 'llm-agent-gemini-ts'
    message: "llm-agent-gemini-ts should appear in meshctl list"

  # llm_agent_gemini_ts tool is registered
  - expr: ${captured.tools_output} contains 'llm_agent_gemini_ts'
    message: "llm_agent_gemini_ts tool should be listed"

  # Response should NOT contain the error (the bug symptom)
  - expr: ${captured.llm_response} not contains 'AI_InvalidPromptError'
    message: "Response should NOT contain AI_InvalidPromptError"

  # Response should NOT contain message format error
  - expr: ${captured.llm_response} not contains 'do not match the ModelMessage'
    message: "Response should NOT contain ModelMessage schema error"

  # Response should contain Paris (successful response)
  - expr: ${captured.llm_response} contains 'Paris'
    message: "LLM response should contain Paris"

post_run:
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
