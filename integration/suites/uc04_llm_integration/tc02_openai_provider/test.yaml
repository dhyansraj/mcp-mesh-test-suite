# Test Case: OpenAI Provider Integration
# Verifies OpenAI API integration through a provider agent

name: "OpenAI Provider Integration"
description: "Test OpenAI GPT provider with ask_gpt tool"
tags:
  - llm
  - openai
  - provider
  - python
timeout: 120

# Note: Skip this test with --skip-tag llm if no API key is available

pre_run:
  # Setup for Python agent
  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

  # Install openai SDK
  - handler: shell
    command: |
      source /workspace/.venv/bin/activate
      pip install openai
    capture: install_output

test:
  # Copy artifacts to workspace
  - handler: shell
    command: "cp -r /artifacts/* /workspace/"
    capture: copy_output

  # Verify provider was copied
  - handler: shell
    command: "ls -la /workspace/openai-provider/"
    capture: ls_output

  # Start the openai-provider
  - handler: shell
    command: "meshctl start openai-provider/main.py --env MCP_MESH_HTTP_PORT=3021 -d"
    workdir: /workspace
    capture: start_output

  # Wait for provider to start
  - handler: wait
    seconds: 5

  # Verify provider is running
  - handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: list_output

  # Test the reverse_string tool (no API required) first
  - handler: shell
    command: "meshctl call reverse_string '{\"text\": \"hello\"}'"
    workdir: /workspace
    capture: reverse_result

  # Test ask_gpt if API key is available
  # This will return an error message if key is missing
  - handler: shell
    command: |
      meshctl call ask_gpt '{"question": "What is the capital of France? Reply with just the city name.", "max_tokens": 50}'
    workdir: /workspace
    capture: gpt_result
    ignore_errors: true

  # Get provider logs for debugging
  - handler: shell
    command: "meshctl logs openai-provider 2>/dev/null | tail -30 || echo 'no logs'"
    workdir: /workspace
    capture: provider_logs

  # Stop provider
  - handler: shell
    command: "meshctl stop"
    workdir: /workspace

assertions:
  # Provider started successfully
  - expr: ${captured.list_output} contains 'openai-provider'
    message: "openai-provider should appear in meshctl list"

  # reverse_string("hello") = "olleh"
  - expr: ${captured.reverse_result} contains 'olleh'
    message: "reverse_string('hello') should return 'olleh'"

  # Note: We don't assert on gpt_result because API key may not be set
  # In mock mode or live mode with key, it would contain "Paris"

post_run:
  # Stop any remaining providers
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
