# Test Case: Provider-Tools Race Condition - Python
# Verifies provider proxy survives tools resolution in different heartbeats
# Related Issue: https://github.com/dhyansraj/mcp-mesh/issues/448

name: "Provider-Tools Race Condition - Py"
description: "Verify @mesh.llm with both provider and filter doesn't lose provider_proxy"
tags:
  - llm
  - claude
  - race
  - python
timeout: 120

# Note: Skip this test with --skip-tag llm if no API key is available

pre_run:
  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

test:
  # Copy UC-level Claude provider artifacts
  - name: "Copy Claude provider to workspace"
    handler: shell
    command: "cp -r /uc-artifacts/claude-provider /workspace/"
    capture: copy_provider_output

  # Copy TC-level calculator-agent artifacts
  - name: "Copy calculator-agent to workspace"
    handler: shell
    command: "cp -r /artifacts/calculator-agent /workspace/"
    capture: copy_calc_output

  # Copy TC-level llm-tools-agent artifacts
  - name: "Copy llm-tools-agent to workspace"
    handler: shell
    command: "cp -r /artifacts/llm-tools-agent /workspace/"
    capture: copy_agent_output

  # Copy .env file from UC artifacts
  - name: "Copy env file"
    handler: shell
    command: "cp /uc-artifacts/.env /workspace/"
    capture: copy_env_output

  # Verify workspace files
  - name: "Verify workspace files"
    handler: shell
    command: "ls -la /workspace/"
    capture: ls_output

  # Start calculator-agent first (provides tools)
  - name: "Start calculator-agent"
    handler: shell
    command: "meshctl start calculator-agent/main.py -d"
    workdir: /workspace
    capture: start_calc_output

  # Wait for calculator to register
  - name: "Wait for calculator to register"
    handler: wait
    seconds: 3

  # Start Claude provider (provides LLM)
  - name: "Start Claude provider"
    handler: shell
    command: "meshctl start claude-provider/main.py --env-file .env -d"
    workdir: /workspace
    capture: start_provider_output

  # Wait for provider to register
  - name: "Wait for provider to register"
    handler: wait
    seconds: 5

  # Verify both are running
  - name: "Verify calculator and provider running"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: pre_agent_list_output

  # Start llm-tools-agent (depends on BOTH calculator and claude-provider)
  # This agent has both provider injection AND tool filter
  - name: "Start llm-tools-agent"
    handler: shell
    command: "meshctl start llm-tools-agent/main.py -d"
    workdir: /workspace
    capture: start_agent_output

  # Wait for agent to register and resolve BOTH provider and tools
  # Use longer wait to allow multiple heartbeats for race condition scenario
  - name: "Wait for agent to register"
    handler: wait
    seconds: 8

  # Verify all agents running
  - name: "Verify all agents running"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: all_list_output

  # List available tools
  - name: "List available tools"
    handler: shell
    command: "meshctl list -t"
    workdir: /workspace
    capture: tools_output

  # Call math_assistant - this will fail if race condition bug exists
  # The bug would cause: "Mesh provider not resolved" or llm=None
  - name: "Call math_assistant - simple math"
    handler: shell
    command: |
      meshctl call math_assistant '{"ctx": {"question": "What is 2 plus 2?"}}'
    workdir: /workspace
    capture: math_response

  # Stop all agents
  - name: "Stop all agents"
    handler: shell
    command: "meshctl stop"
    workdir: /workspace

assertions:
  # Calculator started successfully
  - expr: ${captured.pre_agent_list_output} contains 'calculator-agent'
    message: "calculator-agent should appear in meshctl list"

  # Provider started successfully
  - expr: ${captured.pre_agent_list_output} contains 'claude-provider'
    message: "claude-provider should appear in meshctl list"

  # Agent started successfully
  - expr: ${captured.all_list_output} contains 'llm-tools-agent'
    message: "llm-tools-agent should appear in meshctl list"

  # math_assistant tool is registered
  - expr: ${captured.tools_output} contains 'math_assistant'
    message: "math_assistant tool should be listed"

  # Calculator tools are also visible
  - expr: ${captured.tools_output} contains 'calc_add'
    message: "calc_add tool should be listed"

  # Response should NOT contain the race condition error
  - expr: ${captured.math_response} not contains 'Mesh provider not resolved'
    message: "Response should NOT contain 'Mesh provider not resolved' error"

  # Response should NOT contain None error
  - expr: ${captured.math_response} not contains "'NoneType' object is not callable"
    message: "Response should NOT contain NoneType error"

  # Response should NOT contain race condition RuntimeError
  - expr: ${captured.math_response} not contains 'race condition bug'
    message: "Response should NOT contain race condition error"

  # Response should contain a reasonable answer (4 or four)
  - expr: ${captured.math_response} contains '4'
    message: "LLM response should contain the answer 4"

post_run:
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
