# Test Case: Structured Output - OpenAI Python
# Verifies OpenAI provider returns actual structured data, not JSON schema
# Related Issue: https://github.com/dhyansraj/mcp-mesh/issues/459

name: "Structured Output - OpenAI Py"
description: "Verify OpenAI provider returns structured data (Pydantic), not schema metadata"
tags:
  - llm
  - openai
  - structured
  - python
timeout: 120

# Note: Skip this test with --skip-tag llm if no API key is available

pre_run:
  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

test:
  # Copy UC-level OpenAI provider artifacts
  - name: "Copy OpenAI provider to workspace"
    handler: shell
    command: "cp -r /uc-artifacts/openai-provider /workspace/"
    capture: copy_provider_output

  # Copy TC-level structured-agent artifacts
  - name: "Copy structured-agent to workspace"
    handler: shell
    command: "cp -r /artifacts/structured-agent /workspace/"
    capture: copy_agent_output

  # Copy .env file from UC artifacts
  - name: "Copy env file"
    handler: shell
    command: "cp /uc-artifacts/.env /workspace/"
    capture: copy_env_output

  # Verify workspace files
  - name: "Verify workspace files"
    handler: shell
    command: "ls -la /workspace/"
    capture: ls_output

  # Start OpenAI provider first
  - name: "Start OpenAI provider"
    handler: shell
    command: "meshctl start openai-provider/main.py --env-file .env -d"
    workdir: /workspace
    capture: start_provider_output

  # Wait for provider to register
  - name: "Wait for provider to register"
    handler: wait
    seconds: 5

  # Verify provider is running
  - name: "Verify provider is running"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: provider_list_output

  # Start structured-agent (depends on openai-provider)
  - name: "Start structured-agent"
    handler: shell
    command: "meshctl start structured-agent/main.py -d"
    workdir: /workspace
    capture: start_agent_output

  # Wait for agent to register and resolve dependencies
  - name: "Wait for agent to register"
    handler: wait
    seconds: 5

  # Verify both are running
  - name: "Verify all agents running"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: all_list_output

  # List available tools
  - name: "List available tools"
    handler: shell
    command: "meshctl list -t"
    workdir: /workspace
    capture: tools_output

  # Call get_country_info with France
  - name: "Call get_country_info - France"
    handler: shell
    command: |
      meshctl call get_country_info '{"ctx": {"country_name": "France"}}'
    workdir: /workspace
    capture: structured_response

  # Stop all agents
  - name: "Stop all agents"
    handler: shell
    command: "meshctl stop"
    workdir: /workspace

assertions:
  # Provider started successfully
  - expr: ${captured.provider_list_output} contains 'openai-provider'
    message: "openai-provider should appear in meshctl list"

  # Agent started successfully
  - expr: ${captured.all_list_output} contains 'structured-agent'
    message: "structured-agent should appear in meshctl list"

  # get_country_info tool is registered
  - expr: ${captured.tools_output} contains 'get_country_info'
    message: "get_country_info tool should be listed"

  # Response should contain actual country data (not schema)
  - expr: ${captured.structured_response} contains 'France'
    message: "Response should contain 'France' as country name"

  # Response should contain capital (actual data)
  - expr: ${captured.structured_response} contains 'Paris'
    message: "Response should contain 'Paris' as capital"

  # Response should NOT contain schema metadata (the bug symptom)
  # Schema returns things like {"type": "object"} - check for this pattern
  - expr: "${captured.structured_response} not contains 'object'"
    message: "Response should NOT contain JSON schema type definitions"

post_run:
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
