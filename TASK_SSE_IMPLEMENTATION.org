#+TITLE: SSE Implementation Task
#+DATE: 2026-01-19
#+STATUS: Completed

* Task: Implement Real-time SSE Event Streaming

** Background
The REST API endpoints are complete in =tsuite/tsuite/server.py=, but SSE event
emission during test execution is missing. Currently, the SSE endpoint only
sends initial state.

** Objective
Implement real-time Server-Sent Events that emit during test execution so the
dashboard can show live progress.

** Event Types Implemented

| Event Type      | When Emitted              | Payload                                      |
|-----------------+---------------------------+----------------------------------------------|
| run_started     | Test run begins           | run_id, total_tests, timestamp               |
| test_started    | Individual test starts    | run_id, test_id, name, timestamp             |
| step_completed  | After each step executes  | run_id, test_id, step_index, status, duration|
| test_completed  | Test finishes             | run_id, test_id, status, duration_ms         |
| run_completed   | Entire run finishes       | run_id, passed, failed, skipped, duration_ms |

** Implementation Plan

*** 1. Create SSE Event Manager (sse.py) [DONE]
- [X] Create =tsuite/tsuite/sse.py= module
- [X] Implement thread-safe event queue per run
- [X] Implement event broadcasting mechanism
- [X] Support multiple concurrent subscribers

*** 2. Update Server SSE Endpoint [DONE]
- [X] Modify =/api/runs/<run_id>/stream= to use event manager
- [X] Implement proper event loop with keep-alive
- [X] Handle client disconnection gracefully

*** 3. Integrate with Test Runner [DONE]
- [X] Add hooks in =cli.py= to emit events
- [X] Emit =run_started= at beginning of run
- [X] Emit =test_started= before each test
- [X] Emit =test_completed= after each test
- [X] Emit =run_completed= at end of run
- [ ] Emit =step_completed= after each step (future: requires executor refactor)

*** 4. Add Global Event Stream [DONE]
- [X] Add =/api/events= endpoint for all runs (dashboard live view)
- [X] Support filtering by run_id as query param

** Files Modified/Created

| File                      | Action  | Description                         |
|---------------------------+---------+-------------------------------------|
| tsuite/tsuite/sse.py      | CREATED | SSE event manager module            |
| tsuite/tsuite/server.py   | UPDATED | Updated SSE endpoints, added /api/events |
| tsuite/tsuite/cli.py      | UPDATED | Added event emission hooks          |

** API Endpoints

*** GET /api/runs/<run_id>/stream
Subscribe to events for a specific run. Returns:
- =initial_state= - Current run summary
- =connected= - Connection confirmation
- Live events as they occur

*** GET /api/events
Subscribe to all events (dashboard live view). Optional query param:
- =run_id= - Filter to specific run

** Testing
- [ ] Manual test: Start server, run tests, verify events in browser
- [ ] Verify multiple clients can subscribe
- [ ] Verify events include correct payloads
- [ ] Verify connection cleanup on client disconnect

** Notes
- =step_completed= events are supported by the SSE manager but not yet emitted
  during execution. This would require threading =run_id= through the executor,
  which can be done in a future enhancement.
- All other events (run_started, test_started, test_completed, run_completed)
  are fully functional for both local and Docker modes.

** Completion Criteria
- [X] SSE events emitted in real-time during test execution
- [X] Dashboard can subscribe and receive live updates
- [X] No memory leaks from disconnected clients (cleanup on unsubscribe)
